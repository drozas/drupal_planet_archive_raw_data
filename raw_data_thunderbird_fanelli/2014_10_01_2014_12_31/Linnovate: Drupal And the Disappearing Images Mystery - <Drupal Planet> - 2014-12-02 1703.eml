X-Mozilla-Status: 0000
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                
Date: Tue, 02 Dec 2014 16:03:28 +0000
Message-Id: <http://drupal.org/planet/rss.xml#Tue, 02 Dec 2014 16:03:28 +0000@localhost.localdomain>
From: <Drupal Planet>
MIME-Version: 1.0
Subject: Linnovate: Drupal And the Disappearing Images Mystery
Content-Transfer-Encoding: 8bit
Content-Base: http://www.linnovate.net/blog/drupal-and-disappearing-images-mystery
Content-Type: text/html; charset=UTF-8

<html>
  <head>
    <title>Linnovate: Drupal And the Disappearing Images Mystery</title>
    <base href="http://www.linnovate.net/blog/drupal-and-disappearing-images-mystery">
  </head>
  <body id="msgFeedSummaryBody" selected="false">
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even"><p style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; word-wrap: break-word; color: rgb(85, 85, 85);"><a href="http://www.linnovate.net/blog/drupal-and-disappearing-images-mystery" target="_self"><img alt="" src="https://ehudshahak.files.wordpress.com/2014/11/magician-does-dodgy-disappearing-act-yarpnews.jpg?w=300" style="width: 300px; height: 316px; float: left; padding-right: 10px;"></a></p><p style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; word-wrap: break-word; color: rgb(85, 85, 85);">After working many years with a specific framework, you sometimes face difficulties&nbsp;that in other situations, specifically while learning a new language or framework would not even challenge you.<br>One example for such a case is one I’ve encountered this past week, and to tackle it, all I’ve needed to do is to actually read the Drupal docs and not just flip&nbsp;through it.<br>One of my clients came to me and told me that all of the images he’s uploading to his site are deleted from the files directory of his Drupal project after several hours.<br>After checking that the images are created successfully in the Drupal’s temp directory and are then moved to the files directory as they should, I begun checking for any file/image related modules and any Drupal configurations that could hint a relation to the problem.<br>Checking those off I’ve started to look at custom code developed by our programmers, as this is a more time-consuming task I’ve not started with it but knew from the beginning&nbsp;that this is probably where the culprit could be found.<br>While carefully combing the code I’ve landed upon a form api piece of code related to an image field similar to this:</p>
<pre style="border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170) rgb(170, 170, 170) rgb(204, 204, 204); font-family: monospace, serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; padding: 6px 10px; vertical-align: middle; -webkit-box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-sizing: border-box; border-radius: 2px; height: auto; outline: none; width: 605.484375px; word-wrap: break-word; color: rgb(85, 85, 85); background: rgb(244, 244, 244);">&lt;!--?<span class="hiddenSpellError" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">php
// Use the #managed_file FAPI element to upload an image file.
$form['image_example_image_fid'] = <a class="php-manual" href="http://php.net/array" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="array array([mixed $... = ''])   Create an array">array</a>(
&nbsp; '#title' =&gt; t('Image'),
&nbsp; '#type' =&gt; 'managed_file',
&nbsp; '#description' =&gt; t('The uploaded image will be displayed on this page using the image style chosen below.'),
&nbsp; '#default_value' =&gt; variable_get('image_example_image_fid', ''),
&nbsp; '#upload_location' =&gt; 'public://image_example_images/',
);
?&gt;</span></pre>
<p style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; word-wrap: break-word; color: rgb(85, 85, 85);">This piece of code will add a nice file/image field to the page and will allow you to attach an image to the current entity.<br>After finding the&nbsp;<a href="https://api.drupal.org/api/drupal/developer!topics!forms_api_reference.html/7#managed_file" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" target="_blank">“managed_file” type documentation</a>&nbsp;the problem and the solution was clear.</p><blockquote style="border-left-width: 4px; border-style: none none none solid; border-left-color: rgb(214, 214, 214); font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin: 1.6em 0px; padding-right: 1em; padding-left: 1em; overflow: auto; color: rgb(85, 85, 85); background: rgb(249, 249, 249);"><p style="font-family: Georgia, 'Times New Roman', Times, serif; font-size: 18px; font-style: italic; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: 26px; margin-top: 1.6em; margin-bottom: 1.6em; word-wrap: break-word;"><span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; font-stretch: inherit; line-height: inherit;">Note</span>: New files are uploaded with a status of 0 and are treated as temporary files which are removed after 6 hours via cron. Your module is responsible for changing the $file objects status to FILE_STATUS_PERMANENT and saving the new status to the database. Something like the following within your submit handler should do the trick.</p></blockquote>
<pre style="border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170) rgb(170, 170, 170) rgb(204, 204, 204); font-family: monospace, serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; padding: 6px 10px; vertical-align: middle; -webkit-box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-sizing: border-box; border-radius: 2px; height: auto; outline: none; width: 605.484375px; word-wrap: break-word; color: rgb(85, 85, 85); background: rgb(244, 244, 244);">&nbsp;&lt;!--?<span class="hiddenSpellError" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">php
 // Load the file via file.fid.
 $file = file_load($form_state['values']['my_file_field']);
 // Change status to permanent.
 $file-&gt;status = FILE_STATUS_PERMANENT;
 // Save.
 file_save($file);
 // Record that the module (in this example, user module) is using the file. 
 file_usage_add($file, 'user', 'user', $account-&gt;uid); 
?&gt;</span></pre>
<p style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; word-wrap: break-word; color: rgb(85, 85, 85);">So in order to prevent the (weird – in my opinion) automatic 6 hour cron deletion of the uploaded images you have to add a submit handler and inside it add that piece of code.<br>To clarify and help those in need, this is an expanded example of a form and submit functions.</p>
<pre class="php" style="border-width: 1px; border-style: solid; border-color: rgb(170, 170, 170) rgb(170, 170, 170) rgb(204, 204, 204); font-family: monospace, serif; font-size: 14px; font-stretch: inherit; line-height: 21px; margin-top: 1.6em; margin-bottom: 1.6em; padding: 6px 10px; vertical-align: middle; -webkit-box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-shadow: rgb(255, 255, 255) 0px 1px 0px, rgba(0, 0, 0, 0.2) 0px 1px 1px inset; box-sizing: border-box; border-radius: 2px; height: auto; outline: none; width: 605.484375px; word-wrap: break-word; color: rgb(85, 85, 85); background: rgb(244, 244, 244);"><code style="font-family: monospace, serif; font-size: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px;"><span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form</span> = <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;"><a class="local" href="https://api.drupal.org/api/drupal/includes%21form.inc/function/drupal_get_form/7" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="Returns a renderable form array for a given form ID.">drupal_get_form</a></span>(<span class="php-string" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'my_module_example_form'</span>);
...
<span class="php-keyword" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">function</span> <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">my_module_example_form</span>(<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form</span>, &amp;<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form_state</span>) {
  $form['image_example_image_fid'] = <a class="php-manual" href="http://php.net/array" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="array array([mixed $... = ''])   Create an array">array</a>(
&nbsp;   '#title' =&gt; t('Image'),
&nbsp;   '#type' =&gt; 'managed_file',
&nbsp;   '#description' =&gt; t('The uploaded image will be displayed on this page using the image style chosen below.'),
&nbsp;   '#default_value' =&gt; variable_get('image_example_image_fid', ''),
&nbsp;   '#upload_location' =&gt; 'public://image_example_images/',
  );

<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">    $form</span>[<span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'<a class="local" href="https://api.drupal.org/api/drupal/includes%21form.inc/function/theme_submit/7" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="Returns HTML for a submit button form element.">submit</a>'</span>] = <span class="php-keyword" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">array</span>(
    <span class="php-string" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'#type'</span> =&gt; <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'<a class="local" href="https://api.drupal.org/api/drupal/includes%21form.inc/function/theme_submit/7" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="Returns HTML for a submit button form element.">submit</a>'</span>,
    <span class="php-string" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'#value'</span> =&gt; <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;"><a class="local" href="https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/t/7" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="Translates a string to the current language or to a given language.">t</a></span>(<span class="php-string" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">'Submit'</span>),
  );
  <span class="php-keyword" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">return</span> <span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form</span>;
}
<span class="php-keyword" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">function</span> <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">my_module_example_form_validate</span>(<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form</span>, &amp;<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form_state</span>) {
  <span class="php-comment" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">// Validation logic.
</span>}
<span class="php-keyword" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">function</span> <span class="php-function-or-constant" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">my_module_example_form_submit</span>(<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form</span>, &amp;<span class="php-variable" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">$form_state</span>) {
  <span class="php-comment" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit;">// Submission logic.

   // Load the file via file.fid.
   $file = file_load($form_state['values']['my_file_field']);
   // Change status to permanent.
   $file-&gt;status = <a class="local" href="https://api.drupal.org/api/drupal/includes%21file.inc/constant/FILE_STATUS_PERMANENT/7" style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-stretch: inherit; line-height: inherit; color: rgb(0, 102, 204);" title="Indicates that the file is permanent and should not be deleted.">FILE_STATUS_PERMANENT</a>;
   // Save.
   file_save($file);
   // Record that the module (in this example, user module) is using the file. 
   file_usage_add($file, 'user', 'user', $account-&gt;uid);
  <span style="font-family: inherit; font-size: inherit; font-style: inherit; font-variant: inherit; font-weight: 700; font-stretch: inherit; line-height: inherit;"> // a more generic example of file_usage_add
   // file_usage_add($file, 'my_module_name', 'user or node or any entity', 'that entity id');
   // you don't need to use "file_usage_add" if you're not attaching the image to an entity
</span></span>}</code></pre>
<p><code style="font-family: monospace, serif; font-size: inherit; font-variant: inherit; font-weight: inherit; font-stretch: inherit; line-height: inherit; margin-top: 0px; margin-bottom: 0px;">Originally posted on <a href="https://ehudshahak.wordpress.com/2014/11/29/drupal-and-the-disappearing-images-mystery/">my personal blog</a>.</code></p><div class="wpcnt" style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; font-stretch: inherit; line-height: 0; text-align: center; color: rgb(85, 85, 85);">&nbsp;</div></div></div></div>
  </body>
</html>

