X-Mozilla-Status: 0041
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                
Date: Tue, 20 Aug 2013 15:00:00 +0000
Message-Id: <http://drupal.org/planet/rss.xml#Tue, 20 Aug 2013 15:00:00 +0000@localhost.localdomain>
From: <Drupal Planet>
MIME-Version: 1.0
Subject: EchoDitto Tech Blog: Contextual Complexity Vexes a Texan; or Non-contextual Views Filters, Contextually
Content-Transfer-Encoding: 8bit
Content-Base: http://www.echoditto.com/blog/contextual-complexity-vexes-texan-or-non-contextual-views-filters-contextually
Content-Type: text/html; charset=UTF-8

<html>
  <head>
    <title>EchoDitto Tech Blog: Contextual Complexity Vexes a Texan; or Non-contextual Views Filters, Contextually</title>
    <base href="http://www.echoditto.com/blog/contextual-complexity-vexes-texan-or-non-contextual-views-filters-contextually">
  </head>
  <body id="msgFeedSummaryBody" selected="false">
    <div class="field field-name-field-image field-type-image field-label-hidden"><div class="field-items"><div class="field-item even"><img typeof="foaf:Image" src="http://www.echoditto.com/sites/default/files/styles/medium/public/blog/texashuh.gif?itok=RDGUBdy2" width="220" height="219" alt="" /></div></div></div><div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"> <p>Ok fine, I'm not a Texan.</p><p>But if you, like me, have ever needed a Drupal View's contextual filters to be combined with an "or" operator, you have probably been vexed. Contextual Filters are always combined with an "and" operator.  Whereas standard Views filters can be combined into nested "and/or" groups, if you want to do so contextually, passing url or other arguments to the filter, you are headed upstream in a certain stinky creek, paddleless. </p><p>Until now, dear reader.</p><p>Let's set up a sample use case.  We're making a blog network site, where registered users can post blogs on a variety of topics.  A user can indicate which authors and topics she's interested in.  We want to set up a user dashboard where she can see all blog posts by the authors, and about the topics, in which she's interested.</p><p>If we tried to set up a contextual filter for each of topics and author, the view would only show posts that are by an author she's interested in AND are about a topic she is interested in.  What to do?</p><p><a href="https://api.drupal.org/api/views/views.api.php/function/hook_views_query_alter/7" target="_blank">Hook_views_query_alter</a> would seem like a good candidate.  Drupal's <a href="https://drupal.org/developing/api/database" target="_blank">Database API</a> is reasonably simple and clean, surely we can just use the condition method in conjunction with db_or() to get what we need.  Unfortunately, the query object that is passed to hook_views_query_alter is not the same kind of query object as a standard query.  It's subclassed from views_plugin_query and accepts <a href="https://api.drupal.org/api/views/plugins!views_plugin_query_default.inc/class/views_plugin_query_default/7" target="_blank">these methods</a>.  Certainly an acceptable way to proceed, but it's not documented at all, and I can offer a simple alternative.</p><p>Values of standard views filters can be set programmatically, in <a href="https://api.drupal.org/api/views/views.api.php/function/hook_views_pre_view/7" target="_blank">hook_views_pre_view</a>, using <a href="https://api.drupal.org/api/views/includes!view.inc/function/views_db_object%3A%3Aset_item_option/7" target="_blank">views_db_object::set_item_option</a>.</p><p>All we have to do is set up the standard filters, arranged into "and/or" groups, and leave the values empty.  So we would make a filter for Content Author uid, leaving Usernames blank:</p><p><img alt="" src="/sites/default/files/authorfilter.jpg" style="width: 700px; height: 190px;" /></p><p>And we'd also make a filter for the topics taxonomy, leaving the terms blank like so:</p><p><img alt="" src="/sites/default/files/topicsfilter.jpg" style="width: 700px; height: 259px;" /></p><p>We'd probably also only want to include published nodes, so the final filter setup would look like this:</p><p><img alt="" src="/sites/default/files/filters.jpg" style="width: 373px; height: 163px;" /></p><p>Next we declare hook_views_pre_view in a module and set up a conditional so that we're only targeting the appropriate view.  Here's what the whole block looks like.  Let's say for simplicity that users have already indicated their author and topic interest via reference fields attached to their user objects.</p>
<div class="geshifilter"><div class="php geshifilter-php" style="font-family:monospace;"><pre style="font-family: monospace; font-weight: normal; font-style: normal"><span style="color: #000000; font-weight: bold;">function</span> mymodule_views_pre_view<span style="color: #009900;">(</span><span style="color: #339933;">&amp;</span><span style="color: #000088;">$view</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span><span style="color: #000088;">$display_id</span><span style="color: #339933;">,</span> <span style="color: #339933;">&amp;</span><span style="color: #000088;">$args</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
  <span style="color: #b1b100;">if</span> <span style="color: #009900;">(</span><span style="color: #000088;">$view</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">name</span> <span style="color: #339933;">==</span> <span style="color: #0000ff;">'[my_dashboard_view]'</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
    <span style="color: #666666; font-style: italic;">//grab the user object from the globals</span>
    <span style="color: #000000; font-weight: bold;">global</span> <span style="color: #000088;">$user</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">//load the whole user object with all fields</span>
    <span style="color: #000088;">$full_user</span> <span style="color: #339933;">=</span> user_load<span style="color: #009900;">(</span><span style="color: #000088;">$user</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">uid</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$uids</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$tids</span> <span style="color: #339933;">=</span> <a href="http://www.php.net/array"><span style="color: #990000;">array</span></a><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #666666; font-style: italic;">//loop through field values and make a simple array of tids and uids</span>
    <span style="color: #b1b100;">foreach</span><span style="color: #009900;">(</span><span style="color: #000088;">$full_user</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">field_author_follow</span><span style="color: #009900;">[</span>LANGUAGE_NONE<span style="color: #009900;">]</span>  <span style="color: #b1b100;">as</span> <span style="color: #000088;">$authors</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
      <span style="color: #000088;">$uids</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$authors</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'uid'</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
    <span style="color: #b1b100;">foreach</span><span style="color: #009900;">(</span><span style="color: #000088;">$full_user</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">field_topic_follow</span><span style="color: #009900;">[</span>LANGUAGE_NONE<span style="color: #009900;">]</span> <span style="color: #b1b100;">as</span> <span style="color: #000088;">$topics</span><span style="color: #009900;">)</span><span style="color: #009900;">{</span>
      <span style="color: #000088;">$tids</span><span style="color: #009900;">[</span><span style="color: #009900;">]</span> <span style="color: #339933;">=</span> <span style="color: #000088;">$topics</span><span style="color: #009900;">[</span><span style="color: #0000ff;">'tid'</span><span style="color: #009900;">]</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">}</span>
 
    <span style="color: #666666; font-style: italic;">/*
    finally, set the filters.  the params of of set_item_option are:
    display, 
    what view option to set, in this case 'filter',
    the machine name of the filter, which can be found by looking at the $view object using dsm or similar,
    the string 'value' because that's what we're setting
    and finally an array that represents the value or values.
    */</span>
    <span style="color: #000088;">$view</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">set_item_option</span><span style="color: #009900;">(</span><span style="color: #000088;">$view</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">current_display</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'filter'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'uid'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'value'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$uids</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
    <span style="color: #000088;">$view</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">set_item_option</span><span style="color: #009900;">(</span><span style="color: #000088;">$view</span><span style="color: #339933;">-&gt;</span><span style="color: #004000;">current_display</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'filter'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'field_topics_tid'</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">'value'</span><span style="color: #339933;">,</span> <span style="color: #000088;">$tids</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #009900;">}</span>
<span style="color: #009900;">}</span></pre></div></div><p> </p>
<p>That about does it.  Since the $view object is so unfathomably large and recursive, it can be difficult to find the machine name of the filter, but keep looking, it's nested in there somewhere.  
</p><p>Also note that single values must be nested as the only value in an array.

 </p></div></div></div>
  </body>
</html>

