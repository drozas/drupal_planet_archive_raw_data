X-Mozilla-Status: 0000
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                
Date: Mon, 31 Mar 2014 05:42:07 +0000
Message-Id: <http://drupal.org/planet/rss.xml#Mon, 31 Mar 2014 05:42:07 +0000@localhost.localdomain>
From: <Drupal Planet>
MIME-Version: 1.0
Subject: netsperience 2.x: Connect Drupal to Multiple Remote Databases via SSH Tunnel
Content-Transfer-Encoding: 8bit
Content-Base: http://netsperience.org/content/blog/connect-drupal-multiple-remote-databases-ssh-tunnel
Content-Type: text/html; charset=UTF-8

<html>
  <head>
    <title>netsperience 2.x: Connect Drupal to Multiple Remote Databases via SSH Tunnel</title>
    <base href="http://netsperience.org/content/blog/connect-drupal-multiple-remote-databases-ssh-tunnel">
  </head>
  <body id="msgFeedSummaryBody" selected="false">
    <p><span style="font-size:14px;">I'm working on a site that stores data in separate mysql databases, and updates them frequently from Salesforce via nodejs scripts run through CouchDB. </span></p><p><span style="font-size:14px;">The extra mysql dbs are 16+ GB and it's not practical nor necessary to keep them locally since I only want to <em>read</em> the latest data in local development.</span></p><p><span style="font-size:14px;">Wouldn't it be cool if the local Drupal site can read from the remote database servers?</span></p><p><span style="font-size:14px;">In some cases you can just use the connection you find in the remote site's settings.php:</span></p><p><span style="font-size:14px;">'otherdb' =&gt; 'mysqli://username:password@hostname/dbname'</span></p><p><em><span style="font-size:14px;">(note: it's a Drupal 6 site so that's why you don't see an array - I will give a Drupal 7 example below)</span></em></p><p><span style="font-size:14px;">However, there's often a twist: I must create a<a href="http://en.wikipedia.org/wiki/Tunneling_protocol#Secure_shell_tunneling"> SSH tunnel</a> to connect to this particular db server, based on information clearly presented by <a href="https://support.cloud.engineyard.com/entries/21009887-Access-Your-Database-Remotely-Through-an-SSH-Tunnel">Engine Yard</a>.</span></p><p><span style="font-size:14px;">First, you need to <span style="color: rgb(51, 51, 51); font-family: 'Lucida Sans Unicode', 'Lucida Grande', Verdana, Arial, Helvetica, sans-serif; line-height: 17.399999618530273px;">have configured and installed <a href="http://en.wikipedia.org/wiki/Ssh-keygen">SSH keys</a>&nbsp;</span>on your local and remote machines.</span></p><p><span style="font-size:14px;">Then fire up your terminal and create the SSH tunnel to forward the remote mysql port to a local port. Keep this connection alive as long as you need to connect to the remote database.</span></p><div><strong><span style="font-family:courier new,courier,monospace;"><span style="font-size:14px;">ssh -L&nbsp;</span></span></strong><strong><span style="font-family: 'courier new', courier, monospace;"><span style="font-size: 14px;">[local port]</span></span></strong><strong><span style="font-family:courier new,courier,monospace;"><span style="font-size:14px;">:[database host]:[remote port]&nbsp;</span></span></strong><strong><span style="font-family:courier new,courier,monospace;"><span style="font-size:14px;">[ssh-username]@[remote host]</span></span></strong></div><div>&nbsp;</div><div><span style="font-size:14px;">IMPORTANT: use a different port for your tunnel&nbsp;</span><strong><span style="font-family: 'courier new', courier, monospace;"><span style="font-size: 14px;">[local port]&nbsp;</span></span></strong><span style="font-size: 14px;">than the one you normally use for mysql; for example, if you connect to mysql locally on the default port 3306, use 3307 (or any other unused port) for your tunnel. You should use the correct&nbsp;</span><strong><span style="font-family: 'courier new', courier, monospace;"><span style="font-size: 14px;">[remote port]</span></span></strong><span style="font-size: 14px;">&nbsp;which is typically 3306, and you can see if it is different by looking at settings.php in the remote site.</span></div><div>&nbsp;</div><div><div><strong><span style="font-family: 'courier new', courier, monospace;"><span style="font-size: 14px;">ssh -L 3307:[database host]:3306&nbsp;</span></span></strong><strong><span style="font-family: 'courier new', courier, monospace;"><span style="font-size: 14px;">[ssh-username]@[remote host]</span></span></strong></div></div><div>&nbsp;</div><div><span style="font-size:14px;">Then you can test your connection (in a different terminal instance):</span></div><div>&nbsp;</div><div><strong><span style="font-family:courier new,courier,monospace;"><span style="font-size:14px;">mysql -u[dbuser] -p -P 3307 -h 127.0.0.1</span></span></strong></div><div>&nbsp;</div><div><span style="font-size:14px;">Here is the connection in settings.php for Drupal 6:</span></div><div>&nbsp;</div><div><strong><span style="font-size: 14px;">'otherdb' =&gt; 'mysqli://username:password@127.0.0.1:3307/dbname'</span></strong></div><div>&nbsp;</div><div><span style="font-size: 14px;">What's cool is that you can mix <em>local</em> and <em>remote</em> databases. For example, I want to use a local copy of the Drupal database, which is smaller and easier to sync, and read the data from the second (and third, in my case) remote dbs.</span></div><div>&nbsp;</div><div><strong><span style="font-size:14px;">$db_url = array(</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'default' =&gt; 'mysqli://local-dbuser:password@localhost/local-dbname',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp;&nbsp;'otherdb' =&gt; 'mysqli://username:password@127.0.0.1:3307/dbname',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'otherdb2' =&gt; 'mysqli://username:password@127.0.0.1:3307/dbname2'</span></strong></div><div><strong><span style="font-size:14px;">);</span></strong></div><div>&nbsp;</div><div><span style="font-size:14px;">You can also connect Drupal to the default remote database, but it makes sense to use a local instance for development.</span></div><div>&nbsp;</div><div><em><span style="font-size:14px;">And in Drupal 7:</span></em></div><div>&nbsp;</div><div><strong><span style="font-size:14px;">$databases['default']['default'] = array(</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'driver' =&gt; 'mysql',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'database' =&gt; '</span></strong><strong><span style="font-size: 14px;">local-dbname</span></strong><strong><span style="font-size:14px;">',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'username' =&gt; '</span></strong><strong><span style="font-size: 14px;">local-dbuser</span></strong><strong><span style="font-size:14px;">',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'password' =&gt; 'password',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'host' =&gt; 'localhost',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'prefix' =&gt; '',</span></strong></div><div><strong><span style="font-size:14px;">);</span></strong></div><div><strong><span style="font-size:14px;">$databases['otherdb']['default'] = array(</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'driver' =&gt; 'mysql',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'database' =&gt; 'dbname',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'username' =&gt; '</span></strong><strong><span style="font-size: 14px;">username</span></strong><strong><span style="font-size:14px;">',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'password' =&gt; 'password',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'host' =&gt; '127.0.0.1',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'port' =&gt; '3307',</span></strong></div><div><strong><span style="font-size:14px;">&nbsp; 'prefix' =&gt; '',</span></strong></div><div><strong><span style="font-size:14px;">);</span></strong></div><div>&nbsp;</div><div><hr><p><strong><span style="font-size:16px;">WARNING:&nbsp;</span></strong></p></div><div><u><span style="font-size:16px;">If the db user for the remote db has all privileges, your application may alter the remote database.</span></u></div><div>&nbsp;</div><div><em><span style="font-size:16px;">Therefore, you should create a "read-only" user for the remote database which will prevent you from altering it.</span></em></div><div>&nbsp;</div><div><em><span style="font-size:16px;">THINK</span></em></div><div>&nbsp;</div>
  </body>
</html>

