X-Mozilla-Status: 0000
X-Mozilla-Status2: 00000000
X-Mozilla-Keys:                                                                                
Date: Mon, 20 Jan 2014 16:06:34 +0000
Message-Id: <http://drupal.org/planet/rss.xml#Mon, 20 Jan 2014 16:06:34 +0000@localhost.localdomain>
From: <Drupal Planet>
MIME-Version: 1.0
Subject: Propeople Blog: Configuring Varnish for Drupal 7.20
Content-Transfer-Encoding: 8bit
Content-Base: http://wearepropeople.com/blog/configuring-varnish-for-drupal-720
Content-Type: text/html; charset=UTF-8

<html>
  <head>
    <title>Propeople Blog: Configuring Varnish for Drupal 7.20</title>
    <base href="http://wearepropeople.com/blog/configuring-varnish-for-drupal-720">
  </head>
  <body id="msgFeedSummaryBody" selected="false">
    <div id="comment-wrapper-nid-1397"></div><div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><p>Since the release of Drupal 7.20, all images generated by the ImageCache module have been suffixed by a token. Here’s a detailed explanation that can be found in the release notes:</p>

<p class="quote">The security fixes in this release change all image derivative URLs generated by Drupal to append a token as a query string. ("Image derivatives" are copies of images which the Drupal Image module automatically creates based on configured image styles; for example, thumbnail, medium, large, etc.)</p>

<p>
Links that previously pointed to an URL like: <i>/sites/default/files/styles/thumbnail/public/field/image/example.png</i> will, from now on, point to something like this: <i>/sites/default/files/styles/thumbnail/public/field/image/example.png?itok=zD_VaCaD</i>.
</p>

<p>Nobody seems to have noticed that Varnish is not caching images for authenticated users anymore. The force cache rule for static content no longer works for image derivatives because of the token:
<br /><code>
  #Always cache static files.
  if (req.url ~ "\.(png|gif|jpeg|jpg|ico|swf|css|js|html|htm)(\?[a-z0-9]+)?$") {
    unset req.http.Cookie;
  }
</code>
</p>

<p>The solution we came up with at Propeople Drupal Agency is to change the regexp pattern from the above to the following:
<br /><code>
  if (req.url ~ "\.(png|gif|jpeg|jpg|ico|swf|css|js|html|htm)(\?[\w\d=\.\-]+)?$") {
</code>
</p>

<p>The initial pattern includes <i>(\?[a-z0-9]+)?</i> in order to cover the css/js files cache token generated by Drupal, which looks like <i>?xyz</i>. But the new parameter added to images contains more “=-_” character types.</p>

<p>Also, this fix will add support for caching js files like <i>misc/jquery.js?v=1.4.4</i>, which are not cached by default (this fix is for all Drupal versions).</p>


<p>If you have other blocks in varnish.vcl involving images, you should add the following regexp pattern:
<br /><code>
  # Normalize the Accept-Encoding header. 
	if (req.http.Accept-Encoding) {
    if (req.url ~ "\.(jpg|png|gif|gz|tgz|bz2|tbz|mp3|ogg)(\?[\w\d=\.\-]+)?$" || req.url ~ "^/robots\.txt$") {
</code>
<br />
For more details go to <a href="http://varnish-cache.org/wiki/FAQ/Compression" target="_blank">http://varnish-cache.org/wiki/FAQ/Compression</a>.
</p>
<p>
<code>
  # Don't set cookies on these file types.
  if (req.url ~ "(?i)\.(png|gif|jpeg|jpg|ico|swf|css|js|html|htm)(\?[\w\d=\.\-]+)?$") {
    unset beresp.http.set-cookie;
  }
</code>
</p>

<p>In conclusion, all checks where png, jpg and gif extensions are involved should have 
<i>(\?[\w\d=\.\-]+)?$</i> instead of <i>$</i> and <i>(\?[a-z0-9]+)?$</i>.</p>

<p>I hope you find this article useful. If you have any questions, make sure to post them in the comments below, and I would love to help you out. And don’t forget to subscribe to our mailing list to get our Drupal blog feed directly to your mailbox.</p>
</div></div></div><div class="field field-name-field-tags field-type-taxonomy-term-reference field-label-above"><div class="field-label">Tags:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="/tags/drupal" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Drupal</a></div><div class="field-item odd"><a href="/tags/varnish" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Varnish</a></div><div class="field-item even"><a href="/tags/how-to" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">How to</a></div></div></div><div class="field field-name-field-drupal-planet field-type-taxonomy-term-reference field-label-above"><div class="field-label">Check this option to include this post in Planet Drupal aggregator:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="/drupal/planet" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">planet</a></div></div></div><div class="field field-name-field-topics field-type-taxonomy-term-reference field-label-above"><div class="field-label">Topics:&nbsp;</div><div class="field-items"><div class="field-item even"><a href="/topics/tech-development" typeof="skos:Concept" property="rdfs:label skos:prefLabel" datatype="">Tech &amp; Development</a></div></div></div>
  </body>
</html>

